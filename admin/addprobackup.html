<?php
    require "../dbconnect.php";
    
    $statusMsg = "";
// Handle form submission
// if ($_SERVER["REQUEST_METHOD"] == "POST") // add <?php echo $_SERVER['PHP_SELF']; in form action if req meth is used
if ($_SERVER["REQUEST_METHOD"] == "POST") {
   
    $product_name = $_POST["product_name"];
    $price = $_POST["price"];
    $quantity = $_POST["quantity"];
    $description = $_POST["description"];
    // File upload directory
    $targetDir = "../admin/uploads/";

    if (!empty($_FILES["image"]["name"])) {
        $fileName = basename($_FILES["image"]["name"]);
        $targetFilePath = $targetDir . $fileName;
        $fileType = pathinfo($targetFilePath, PATHINFO_EXTENSION);

        // Allow certain file formats
        $allowTypes = array('jpg', 'png', 'jpeg', 'gif');

        if (in_array($fileType, $allowTypes)) {
            // Upload file to server
            if (move_uploaded_file($_FILES["image"]["tmp_name"], $targetFilePath)) {
                // Insert data into database
                $sql = "INSERT INTO product_tbl (product_name, price, quantity, image, description)
                        VALUES ('$product_name', $price, $quantity, '$fileName', '$description')";
                
                if ($conn->query($sql) === TRUE) {
                    $statusMsg = "New Product created successfully";
                } else {
                    $statusMsg = "Error: Failed to add product";
                }
            } else {
                $statusMsg = "Sorry, there was an error uploading your file.";
            }
        } else {
            $statusMsg = 'Sorry, only JPG, JPEG, PNG, & GIF files are allowed to upload.';
        }
    } else {
        $statusMsg = 'Please select a file to upload.';
    }
}    


    // Execute the query for the prev code without img
    // if ($conn->query($sql) === TRUE) {
    //     echo "New record created successfully";
    // } else {
    //     echo "Error: Failed to add product";
    // }


?>

<!DOCTYPE html>
<html>
<head>
    <title>Insert Product</title>
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

<div class="add-pro-container">
    <h3>Insert Product</h3>
    
    <form method="POST" action="<?php echo $_SERVER['PHP_SELF'];?>" enctype="multipart/form-data" class="add-pro-form" name="addProduct">
        <div class="add-pro-group">
            <label class="add-pro-label">Product Name:</label>
            <input type="text" class="add-pro-input" name="product_name" required>
        </div>
        
        <div class="add-pro-group">
            <label class="add-pro-label">Price:</label>
            <input type="number" class="add-pro-input" name="price" required>
        </div>
        
        <div class="add-pro-group">
            <label class="add-pro-label">Quantity:</label>
            <input type="number" class="add-pro-input qty" name="quantity" required>
        </div>
        
        <div class="add-pro-group">
            <label class="add-pro-label">Image:</label>
            <input type="file" class="add-pro-input" name="image" accept=".jpg, .jpeg, .png" value="" required>
        </div>
        
        <div class="add-pro-group">
            <label class="add-pro-label">Description:</label>
            <textarea class="add-pro-input" name="description" required></textarea>
        </div>
        
        <div class="add-pro-group">
            <input type="submit" class="add-pro-submit" value="Submit" name="submit">
        </div>

        <div class="status-msg">
        <?php echo $statusMsg; ?>
    </div>
    </form>
    
</div>
  

</body>
</html>